<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Push Notifications</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
      margin-bottom: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.success {
      background: #28a745;
    }
    button.success:hover {
      background: #218838;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      color: #0c5460;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      color: #856404;
    }
    .success-msg {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      color: #155724;
      display: none;
    }
    .success-msg.show {
      display: block;
    }
    .error-msg {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      color: #721c24;
      display: none;
    }
    .error-msg.show {
      display: block;
    }
    .status {
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
    }
    .status-item {
      margin: 5px 0;
    }
    .status-item strong {
      display: inline-block;
      width: 180px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîî Manage Push Notifications</h1>
    <p class="subtitle">Subscribe to job board updates on this device</p>

    <div class="info">
      <strong>‚ÑπÔ∏è How it works:</strong>
      <ul>
        <li>Each device needs its own subscription</li>
        <li>You'll receive notifications even when the app is closed</li>
        <li>Works on Android, iOS 16.4+, Desktop browsers</li>
        <li>Requires notification permission</li>
      </ul>
    </div>

    <div id="status" class="status">
      <div class="status-item">
        <strong>Browser Support:</strong>
        <span id="browserSupport">Checking...</span>
      </div>
      <div class="status-item">
        <strong>Permission Status:</strong>
        <span id="permissionStatus">Checking...</span>
      </div>
      <div class="status-item">
        <strong>Subscription Status:</strong>
        <span id="subscriptionStatus">Checking...</span>
      </div>
      <div class="status-item" id="endpointContainer" style="display: none;">
        <strong>Endpoint:</strong>
        <span id="endpoint" style="word-break: break-all;"></span>
      </div>
    </div>

    <div id="successMsg" class="success-msg"></div>
    <div id="errorMsg" class="error-msg"></div>

    <button id="subscribeBtn" onclick="subscribe()" style="display: none;">
      üì± Subscribe to Notifications
    </button>

    <button id="unsubscribeBtn" class="danger" onclick="unsubscribe()" style="display: none;">
      üîï Unsubscribe
    </button>

    <button id="testBtn" class="success" onclick="testNotification()" style="display: none;">
      üß™ Test Notification
    </button>

    <div class="warning" id="iosWarning" style="display: none;">
      <strong>‚ö†Ô∏è iOS Users:</strong> You must install this site as a PWA (Add to Home Screen) before subscribing to push notifications.
    </div>
  </div>

  <script>
    let currentSubscription = null;

    // Check browser support and update status
    async function checkStatus() {
      const browserSupport = document.getElementById('browserSupport');
      const permissionStatus = document.getElementById('permissionStatus');
      const subscriptionStatus = document.getElementById('subscriptionStatus');
      const subscribeBtn = document.getElementById('subscribeBtn');
      const unsubscribeBtn = document.getElementById('unsubscribeBtn');
      const testBtn = document.getElementById('testBtn');
      const endpointContainer = document.getElementById('endpointContainer');
      const endpoint = document.getElementById('endpoint');
      const iosWarning = document.getElementById('iosWarning');

      // Check browser support
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        browserSupport.textContent = '‚ùå Not Supported';
        browserSupport.style.color = '#dc3545';
        return;
      }

      browserSupport.textContent = '‚úÖ Supported';
      browserSupport.style.color = '#28a745';

      // Check if iOS in standalone mode
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;

      if (isIOS && !isStandalone) {
        iosWarning.style.display = 'block';
      }

      // Check notification permission
      if (!('Notification' in window)) {
        permissionStatus.textContent = '‚ùå Not Supported';
        permissionStatus.style.color = '#dc3545';
        return;
      }

      const permission = Notification.permission;
      if (permission === 'granted') {
        permissionStatus.textContent = '‚úÖ Granted';
        permissionStatus.style.color = '#28a745';
      } else if (permission === 'denied') {
        permissionStatus.textContent = '‚ùå Denied';
        permissionStatus.style.color = '#dc3545';
        return;
      } else {
        permissionStatus.textContent = '‚ö†Ô∏è Not Requested';
        permissionStatus.style.color = '#ffc107';
      }

      // Check subscription status
      try {
        const registration = await navigator.serviceWorker.ready;
        currentSubscription = await registration.pushManager.getSubscription();

        if (currentSubscription) {
          subscriptionStatus.textContent = '‚úÖ Subscribed';
          subscriptionStatus.style.color = '#28a745';
          unsubscribeBtn.style.display = 'block';
          testBtn.style.display = 'block';

          // Show endpoint
          endpointContainer.style.display = 'block';
          endpoint.textContent = currentSubscription.endpoint;
        } else {
          subscriptionStatus.textContent = '‚ùå Not Subscribed';
          subscriptionStatus.style.color = '#dc3545';
          subscribeBtn.style.display = 'block';
        }
      } catch (error) {
        subscriptionStatus.textContent = '‚ùå Error: ' + error.message;
        subscriptionStatus.style.color = '#dc3545';
      }
    }

    // Subscribe to push notifications
    async function subscribe() {
      const subscribeBtn = document.getElementById('subscribeBtn');
      const successMsg = document.getElementById('successMsg');
      const errorMsg = document.getElementById('errorMsg');

      subscribeBtn.disabled = true;
      subscribeBtn.textContent = 'Subscribing...';
      successMsg.classList.remove('show');
      errorMsg.classList.remove('show');

      try {
        // Request notification permission
        const permission = await Notification.requestPermission();

        if (permission !== 'granted') {
          throw new Error('Notification permission denied');
        }

        // Wait for service worker
        const registration = await navigator.serviceWorker.ready;

        // Get VAPID public key from server
        const response = await fetch('/api/push/vapid-public-key');
        if (!response.ok) {
          throw new Error('Failed to get VAPID public key from server');
        }

        const { publicKey } = await response.json();

        // Convert VAPID key
        const convertedVapidKey = urlBase64ToUint8Array(publicKey);

        // Subscribe to push
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: convertedVapidKey
        });

        // Send subscription to server
        const saveResponse = await fetch('/api/push/subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ subscription })
        });

        if (!saveResponse.ok) {
          throw new Error('Failed to save subscription to server');
        }

        successMsg.textContent = '‚úÖ Successfully subscribed to push notifications!';
        successMsg.classList.add('show');

        // Refresh status
        await checkStatus();
      } catch (error) {
        errorMsg.textContent = '‚ùå Error: ' + error.message;
        errorMsg.classList.add('show');
        subscribeBtn.disabled = false;
        subscribeBtn.textContent = 'üì± Subscribe to Notifications';
      }
    }

    // Unsubscribe from push notifications
    async function unsubscribe() {
      const unsubscribeBtn = document.getElementById('unsubscribeBtn');
      const successMsg = document.getElementById('successMsg');
      const errorMsg = document.getElementById('errorMsg');

      unsubscribeBtn.disabled = true;
      unsubscribeBtn.textContent = 'Unsubscribing...';
      successMsg.classList.remove('show');
      errorMsg.classList.remove('show');

      try {
        if (!currentSubscription) {
          throw new Error('No active subscription found');
        }

        // Unsubscribe from push service
        await currentSubscription.unsubscribe();

        // Remove from server
        const response = await fetch('/api/push/unsubscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ endpoint: currentSubscription.endpoint })
        });

        if (!response.ok) {
          throw new Error('Failed to remove subscription from server');
        }

        successMsg.textContent = '‚úÖ Successfully unsubscribed from push notifications';
        successMsg.classList.add('show');

        // Refresh status
        await checkStatus();
      } catch (error) {
        errorMsg.textContent = '‚ùå Error: ' + error.message;
        errorMsg.classList.add('show');
        unsubscribeBtn.disabled = false;
        unsubscribeBtn.textContent = 'üîï Unsubscribe';
      }
    }

    // Test notification
    async function testNotification() {
      const testBtn = document.getElementById('testBtn');
      const successMsg = document.getElementById('successMsg');
      const errorMsg = document.getElementById('errorMsg');

      testBtn.disabled = true;
      testBtn.textContent = 'Sending test...';
      successMsg.classList.remove('show');
      errorMsg.classList.remove('show');

      try {
        const registration = await navigator.serviceWorker.ready;

        await registration.showNotification('Test Notification', {
          body: 'If you see this, notifications are working! üéâ',
          icon: '/web-app-manifest-192x192.png',
          badge: '/notification-badge.png',
          tag: 'test-notification',
          requireInteraction: false
        });

        successMsg.textContent = '‚úÖ Test notification sent! Check your notification area.';
        successMsg.classList.add('show');

        testBtn.disabled = false;
        testBtn.textContent = 'üß™ Test Notification';
      } catch (error) {
        errorMsg.textContent = '‚ùå Error: ' + error.message;
        errorMsg.classList.add('show');
        testBtn.disabled = false;
        testBtn.textContent = 'üß™ Test Notification';
      }
    }

    // Convert base64 VAPID key to Uint8Array
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');

      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // Check status on load
    checkStatus();
  </script>
</body>
</html>
